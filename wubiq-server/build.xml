<?xml version="1.0"?>
 
<project name="wubiq-server" basedir="." default="update-wubiq">

	<property name="project" value="wubiq-server" />
	<property name="dist" value="${basedir}/dist" />
	<property name="src" value="${basedir}/src" />
	<property name="bin" value="${basedir}/bin" />
	<property name="lib" value="${basedir}/lib" />
	<property name="lib-nondeploy" value="${basedir}/lib-nondeploy" />
	<property name="output.jar" value="${dist}/${project}.jar" />
	<property name="workspace.dir" value="${basedir}/.." />
	<property name="basedir.common" value="${workspace.dir}/wubiq-common" />
	
	<path id="project.classpath">
		<pathelement path="${lib}"/>
		<pathelement path="${bin}"/>
		<fileset dir="${lib}"> 
			<include name="**/*.jar"/> 
		</fileset> 
		<fileset dir="${lib-nondeploy}"> 
			<include name="**/*.jar"/> 
		</fileset> 
	</path>
	
	<path id="project.src">
		<pathelement path="${src}"/>
	</path>	
	
	<target name="update-wubiq">
		<input message="Enter project name" addproperty="target.project" />
		<input message="Web folder" addproperty="webdir" defaultvalue="WebContent" />
		<available file="${workspace.dir}/${target.project}/${webdir}" property="project-exists" />
		<echo message="Project ${target.project} exists: ${project-exists}" />
		<antcall target="update-wubiq-all" />
	</target>
	
	<target name="update-wubiq-all" depends="create-server-jar" if="project-exists" >
		<copy todir="${workspace.dir}/${target.project}/${webdir}/WEB-INF/lib" overwrite="true">
			<fileset file="${output.jar}" />
			<fileset dir="${lib}">
				<include name="*.jar" />
			</fileset>
		</copy>
		<antcall target="web-xml" />
	</target>

	<target name="web-xml">
		<available file="${workspace.dir}/${target.project}/${webdir}/WEB-INF/web.xml" property="web-exists" />
		<echo message="web.xml exists: ${web-exists}" />
		<antcall target="create-web-xml" />
		<antcall target="update-web-xml" />
	</target>
	
	<target name="create-web-xml" unless="web-exists">
		<concat destfile="${workspace.dir}/${target.project}/${webdir}/WEB-INF/web.xml">
&lt;web-app xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://java.sun.com/xml/ns/javaee" xmlns:web="http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd" xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd" id="WebApp_ID" version="2.5"&gt;
	&lt;display-name&gt;${target.project}&lt;/display-name&gt;
	&lt;!-- wubiq servlet --&gt;
	&lt;servlet&gt;
		&lt;servlet-name&gt;wubiq&lt;/servlet-name&gt;
		&lt;servlet-class&gt;net.sf.wubiq.servlets.RemotePrintServlet&lt;/servlet-class&gt;
	&lt;/servlet&gt;
	&lt;servlet-mapping&gt;
		&lt;servlet-name&gt;wubiq&lt;/servlet-name&gt;
		&lt;url-pattern&gt;/wubiq.do&lt;/url-pattern&gt;
	&lt;/servlet-mapping&gt;
&lt;/web-app&gt;		
		</concat>
	</target>
		
	<target name="update-web-xml" if="web-exists">
		<condition property="web-defined">
			<isfileselected file="${workspace.dir}/${target.project}/${webdir}/WEB-INF/web.xml">
				<contains text="net.sf.wubiq.servlets.RemotePrintServlet" />
			</isfileselected>
		</condition>
		<echo message="wubiq defined in web.xml: ${web-defined}" />
		<antcall target="update-web-xml-replace" />
	</target>
	
	<target name="update-web-xml-replace" unless="web-defined">
		<replace file="${workspace.dir}/${target.project}/${webdir}/WEB-INF/web.xml">
			<replacetoken>&lt;/web-app&gt;</replacetoken>
		</replace>
		<concat destfile="${workspace.dir}/${target.project}/${webdir}/WEB-INF/web.xml" append="true">
	&lt;!-- wubiq servlet --&gt;
	&lt;servlet&gt;
		&lt;servlet-name&gt;wubiq&lt;/servlet-name&gt;
		&lt;servlet-class&gt;net.sf.wubiq.servlets.RemotePrintServlet&lt;/servlet-class&gt;
	&lt;/servlet&gt;
	&lt;servlet-mapping&gt;
		&lt;servlet-name&gt;wubiq&lt;/servlet-name&gt;
		&lt;url-pattern&gt;/wubiq.do&lt;/url-pattern&gt;
	&lt;/servlet-mapping&gt;
&lt;/web-app&gt;		
		</concat>
	</target>
	
	<target name="create-server-jar" depends="clean">
		<available file="${basedir.common}" property="wubiq-common-exists" />
		<antcall target="create-common-jar" />
		<javac destdir="${bin}" nowarn="true" failonerror="true" errorproperty="builds.failed" 
				debug="true"> 
			<src refid="project.src"/>
			<classpath refid="project.classpath" /> 
		</javac>
		<jar jarfile="${output.jar}">
			<fileset dir="${bin}" />
			<fileset dir="${basedir}/i18n">
				<include name="*" />
			</fileset>
			<fileset dir="${src}" includes="net/sf/wubiq/reports/*.pdf" />
		</jar>
	</target>
	
	<target name="create-common-jar" if="wubiq-common-exists">
		<ant antfile="${basedir.common}/build.xml" dir="${basedir.common}" target="create-common-jar" 
				inheritall="false" inheritrefs="false"/>
		<copy file="${basedir.common}/dist/wubiq-common.jar" todir="${lib}" />
	</target>
		
	<target name="clean">
		<delete dir="${dist}" failonerror="false" />
		<delete dir="${bin}" failonerror="false" />
		<mkdir dir="${dist}"/>
		<mkdir dir="${bin}"/>
	</target>
</project>
